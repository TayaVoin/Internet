events {
    worker_connections 1024;
}

http {
    # Логирование для отладки
    access_log /dev/stdout;
    error_log /dev/stderr;

    # Upstream для первого сервиса (devices)
    upstream devices_service {
        server host.docker.internal:8106;
    }

    # Upstream для второго сервиса (other)
    upstream other_service {
        server host.docker.internal:8107;
    }

    server {
        listen 8080;
        
        # Корневой маршрут для проверки
        location / {
            return 200 "API Gateway for devices service is running!\n";
        }

        # Маршрут для devices (ваш основной ресурс)
        location /api/devices {
            proxy_pass http://devices_service/api/devices;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Маршрут для конкретного device по ID
        location /api/devices/ {
            proxy_pass http://devices_service/api/devices/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Маршрут для other (второй сервис)
        location /api/other {
            proxy_pass http://other_service/api/other;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Маршрут для конкретного other item по ID
        location /api/other/ {
            proxy_pass http://other_service/api/other/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Health check для обоих сервисов через gateway
        location /health {
            return 200 "Gateway is healthy\n";
        }
    }
}